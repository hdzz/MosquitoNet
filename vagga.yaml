containers:
  copyright-header:
    setup:
    - !UbuntuRelease { version: 15.10 }
    - !UbuntuUniverse
    - !Install [ ca-certificates, ruby, ruby-dev, zlib1g-dev, make, build-essential, libicu-dev ]
    - !Sh gem install copyright-header

  build:
    setup:
    - !UbuntuRelease { version: 15.10 }
    - !UbuntuUniverse
    - !Install [ make, cmake, clang, gcc, g++, libboost-all-dev, ca-certificates, gdbserver, haskell-platform, rsync ]
    - !Env
      HOME: /root # For cabal
    - !Sh |
        cabal update
        cabal install filemanip megaparsec shake text
    volumes:
      /tmp: !Tmpfs {size: 1Gi}

commands:
  add-copyright-headers: !Command
    description: Add copyright header to C++ files
    accepts-arguments: true
    container: copyright-header
    work-dir: .
    run: copyright-header/add-header "$@"
  test: !Command
    description: Build and test everything
    accepts-arguments: true
    container: build
    work-dir: haskell
    environ: { HOME: /root }
    run: ./Build.hs "$@"
  quick: !Command
    description: Build gcc Debug and run tests
    accepts-arguments: false
    container: build
    work-dir: haskell
    environ: { HOME: /root }
    run: ./Build.hs quick
  clean: !Command
    description: Clean build and test results
    accepts-arguments: false
    container: build
    work-dir: haskell
    environ: { HOME: /root }
    run: ./Build.hs clean

